<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роиро╛ройрпН роХро╡ро┐родрпИ - Kavithai & Web3 Platform</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans-Tamil:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css"> 

    <script type="module" src="auth.js"></script> 
    <script type="module" src="script.js"></script> 
    <script type="module" src="search.js"></script> 
    <script type="module" src="comments.js"></script> 


    <script type="module">
        // --- 2. GLOBAL JAVASCRIPT LOGIC ---
        
        // Import necessary functions from Firebase SDKs
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // Import required functions from local files
        import { executeSearchQuery } from "./search.js"; 
        import { loadComments, postComment, ratePoem, handleReaction, toggleBookmark } from "./comments.js"; 

        // Expose functions globally for dynamic HTML buttons to use
        window.loadComments = loadComments;
        window.postComment = postComment;
        window.ratePoem = ratePoem;
        window.handleReaction = handleReaction;
        window.toggleBookmark = toggleBookmark;

        // CRITICAL FIX: Get the Auth instance initialized in auth.js
        const auth = getAuth(); 
        const provider = new GoogleAuthProvider();

        // 4. GOOGLE SIGN-IN FUNCTION 
        window.signInWithGoogle = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                window.showToastNotification(`роЙро│рпНроирпБро┤рпИро╡рпБ ро╡рпЖро▒рпНро▒ро┐! Welcome ${user.displayName || 'роХро╡ро┐роЮро░рпЗ'}!`, 'success');
            } catch (error) {
                // ... Error handling remains the same ...
                window.showToastNotification("роЙро│рпНроирпБро┤рпИро╡ро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯродрпБ. (Auth Console-роР роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН)", 'error');
            }
        };

        // 5. SIGN-OUT FUNCTION
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                window.showToastNotification("ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ ро╡рпЖро│ро┐ропрпЗро▒ро┐ройрпАро░рпНроХро│рпН.", 'info');
            } catch (error) {
                // ... Error handling remains the same ...
                window.showToastNotification("ро╡рпЖро│ро┐ропрпЗро▒рпБро╡родро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯродрпБ.", 'error');
            }
        };


        // 7. CORE FIX: Function to load the latest approved poems on the homepage
        async function loadHomepagePoems() {
            const listElement = document.getElementById('homepage-poem-list');
            if (!listElement) return;

            listElement.innerHTML = '<p style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> роХро╡ро┐родрпИроХро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ройрпНро▒рой...</p>';
            
            const latestPoems = await executeSearchQuery("", { sort: 'date-desc', theme: 'all', geo: 'global', token: 'none' }, 10); 

            listElement.innerHTML = ''; 

            if (latestPoems.length === 0) {
                listElement.innerHTML = '<p style="text-align:center; color:#777;">роТрокрпНрокрпБродро▓рпН роЕро│ро┐роХрпНроХрокрпНрокроЯрпНроЯ роХро╡ро┐родрпИроХро│рпН роОродрпБро╡рпБроорпН роЗро▓рпНро▓рпИ. роиро┐ро░рпНро╡ро╛роХро┐ роТрокрпНрокрпБродро▓рпБроХрпНроХро╛роХроХрпН роХро╛родрпНродро┐ро░рпБроХрпНроХро╡рпБроорпН.</p>';
                return;
            }

             latestPoems.forEach(poem => {
                const card = document.createElement('div');
                card.className = 'poem-card'; 
                card.id = `poem-${poem.id}`;
                
                const avgRating = poem.averageRating ? poem.averageRating.toFixed(1) : 'N/A';
                const likes = poem.likes || 0;
                const postDate = poem.timestamp ? new Date(poem.timestamp.toDate()).toLocaleDateString('ta-IN') : 'N/A';
                
                card.innerHTML = `
                    <div class="poem-summary">
                        <h3>${poem.title}</h3>
                        <p>${poem.content ? poem.content.substring(0, 150) : 'роЙро│рпНро│роЯроХрпНроХроорпН роЗро▓рпНро▓рпИ'}...</p>
                        <div class="poem-meta" style="font-size: 0.9em; color:#777;">
                            роЖроЪро┐ро░ро┐ропро░рпН: <a href="profile?uid=${poem.authorId}" style="color:var(--secondary-color);">${poem.authorName || 'роЕро▒ро┐ропрокрпНрокроЯро╛родро╡ро░рпН'}</a> | рокродро┐ро╡ро┐роЯрпНроЯ роиро╛ро│рпН: ${postDate}
                        </div>
                    </div>

                    <div class="action-bar">
                        <div>
                            <span class="rating" style="color:var(--warning-color);"><i class="fas fa-star"></i> ${avgRating}</span>
                            <span class="likes" style="color:var(--primary-color); margin-left: 15px;"><i class="fas fa-heart"></i> ${likes}</span>
                        </div>
                        <button onclick="togglePoemDetails('${poem.id}')" data-expanded="false" class="approve-btn" style="float: right;">
                            <i class="fas fa-chevron-down"></i> роорпЗро▓рпБроорпН роХро╛рогрпНроХ
                        </button>
                    </div>

                    <div id="details-${poem.id}" class="full-details-section" style="display:none; margin-top: 20px; padding-top: 20px;">
                        
                        <pre style="white-space: pre-wrap;">${poem.content}</pre>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
                            <div>
                                <span>роЙроЩрпНроХро│рпН роородро┐рокрпНрокрпАроЯрпБ:</span>
                                <i class="fas fa-star rating-star" data-poem-id="${poem.id}" data-value="1" onclick="ratePoem(1, '${poem.id}')"></i>
                                <i class="fas fa-star rating-star" data-poem-id="${poem.id}" data-value="2" onclick="ratePoem(2, '${poem.id}')"></i>
                                <i class="fas fa-star rating-star" data-poem-id="${poem.id}" data-value="3" onclick="ratePoem(3, '${poem.id}')"></i>
                                <i class="fas fa-star rating-star" data-poem-id="${poem.id}" data-value="4" onclick="ratePoem(4, '${poem.id}')"></i>
                                <i class="fas fa-star rating-star" data-poem-id="${poem.id}" data-value="5" onclick="ratePoem(5, '${poem.id}')"></i>
                            </div>
                            <div>
                                <button onclick="handleReaction('like', '${poem.id}')" class="approve-btn" style="background-color: var(--primary-color);"><i class="fas fa-heart"></i> рокро┐роЯро┐роХрпНроХрпБроорпН</button>
                                <button onclick="toggleBookmark('${poem.id}')" class="approve-btn" style="background-color: #999;"><i class="fas fa-bookmark"></i> роЪрпЗрооро┐</button>
                            </div>
                        </div>

                        <div class="comments-section">
                            <h4>ЁЯЧгя╕П роХро░рпБродрпНродрпБроХрпНроХро│рпН (<span id="comment-count-${poem.id}">0</span>)</h4>
                            <textarea id="comment-input-${poem.id}" placeholder="роХро░рпБродрпНродрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН..." style="width:100%; margin-bottom: 10px;"></textarea>
                            <button class="comment-post-btn" onclick="postComment('${poem.id}', document.getElementById('comment-input-${poem.id}').value)">роХро░рпБродрпНродрпБ роЗроЯрпБроХ</button>
                            <div id="comments-list-${poem.id}" style="margin-top: 15px;">
                                <p style="text-align:center; font-style:italic;">роХро░рпБродрпНродрпБроХро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ройрпНро▒рой...</p>
                            </div>
                        </div>
                    </div>
                `;
                listElement.appendChild(card);
            });
        }

        // New function to toggle the details section
        window.togglePoemDetails = function(poemId) {
            const detailsEl = document.getElementById(`details-${poemId}`);
            const button = document.querySelector(`#poem-${poemId} button`);

            if (detailsEl.style.display === 'none' || detailsEl.style.display === '') {
                detailsEl.style.display = 'block';
                button.innerHTML = '<i class="fas fa-chevron-up"></i> роЪрпБро░рпБроХрпНроХрпБроХ';
                window.loadComments(poemId); 
            } else {
                detailsEl.style.display = 'none';
                button.innerHTML = '<i class="fas fa-chevron-down"></i> роорпЗро▓рпБроорпН роХро╛рогрпНроХ';
            }
        };

        // 6. AUTH STATE LISTENER 
        onAuthStateChanged(auth, (user) => {
            // ... existing auth logic ...
            loadHomepagePoems();
        });
        
        // Call the function when the DOM is ready
        document.addEventListener('DOMContentLoaded', loadHomepagePoems);
    </script>
</head>
<body>

    <header>
        <div class="header-content">
            <h1>роиро╛ройрпН роХро╡ро┐родрпИ</h1>
            <p>родрооро┐ро┤ро┐ро▓рпН роХро╡ро┐родрпИроХро│рпН, Web3 & AI-ройрпН роЪроЩрпНроХроороорпН</p>
        </div>
        
        <nav>
            <a href="index.html">роорпБроХрокрпНрокрпБ (Feed)</a>
            <a id="nav-create-poem" href="create" style="display:none;"> 
                <i class="fas fa-feather-alt"></i> роХро╡ро┐родрпИ роЙро░рпБро╡ро╛роХрпНроХрпБ
            </a>
            <a href="forum">роЪроорпВроХроорпН (Forum)</a>
            <a href="monetization">роЪроирпНродро╛ (Premium)</a>
            <a id="nav-admin" href="admin" class="admin-link" style="display:none;">
                <i class="fas fa-cog"></i> роиро┐ро░рпНро╡ро╛роХроорпН
            </a>
            <a href="settings">роЕроорпИрокрпНрокрпБроХро│рпН</a>
        </nav>

        <div id="auth-container">
            <div id="login-section">
                <button onclick="signInWithGoogle()" class="google-sign-in-btn">
                    <i class="fab fa-google"></i> Google/Gmail роЙро│рпНроирпБро┤рпИро╡рпБ
                </button>
                <a href="web3" class="wallet-login-btn">
                    <i class="fas fa-wallet"></i> External Wallet Login (Web3)
                </a>
            </div>

            <div id="user-profile-section" style="display: none;">
                <span id="user-name-display">
                    <i class="fas fa-user-circle"></i> <span id="user-name"></span> роХрпНроХрпБ роиро▓рпНро╡ро░ро╡рпБ!
                </span>
                <a href="profile" class="profile-btn">роЪрпБропро╡ро┐ро╡ро░роорпН</a>
                <button onclick="signOutUser()" class="signout-btn">ро╡рпЖро│ро┐ропрпЗро▒рпБ</button>
                <i class="fas fa-bell notification-icon"></i> </div>
        </div>
        
    </header>

    <main>
        <h2>роЪроорпАрокродрпНродро┐роп роХро╡ро┐родрпИрокрпН рокродро┐ро╡рпБроХро│рпН</h2>
        <div id="homepage-poem-list">
            <p style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> роХро╡ро┐родрпИроХро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ройрпНро▒рой...</p>
        </div>
        
        <p style="text-align: center; margin-top: 30px;">
            <a href="search" class="approve-btn">ЁЯФО роЕройрпИродрпНродрпБроХрпН роХро╡ро┐родрпИроХро│рпИропрпБроорпН родрпЗроЯрпБ</a>
        </p>
    </main>

    <footer>
        <p class="copyright-text">&copy; 2024 роиро╛ройрпН роХро╡ро┐родрпИ. роЕройрпИродрпНродрпБ роЙро░ро┐роорпИроХро│рпБроорпН рокро╛родрпБроХро╛роХрпНроХрокрпНрокроЯрпНроЯро╡рпИ. | <a href="gdpr">GDPR/родро░ро╡рпБроХрпН роХрпЛро░ро┐роХрпНроХрпИ</a></p>
        
        <div class="contact-icons">
            <a href="mailto:naankavithaiweb@gmail.com" title="рооро┐ройрпНройроЮрпНроЪро▓рпН" class="icon-btn"><i class="fas fa-envelope"></i></a>
            <a href="https://wa.me/94752351754" target="_blank" title="ро╡ро╛роЯрпНро╕рпНроЕрокрпН (Mobile)" class="icon-btn"><i class="fab fa-whatsapp"></i></a>
            <a href="tel:+94752351754" title="роорпКрокрпИро▓рпН роЕро┤рпИрокрпНрокрпБ" class="icon-btn"><i class="fas fa-phone"></i></a>
            <a href="https://t.me/Mohammed_Sahan_1" target="_blank" title="роЯрпЖро▓ро┐роХро┐ро░ро╛роорпН ID" class="icon-btn"><i class="fab fa-telegram-plane"></i></a>
            <a href="https://t.me/Naan_kavithai" target="_blank" title="роЯрпЖро▓ро┐роХро┐ро░ро╛роорпН роЪрпЗройро▓рпН" class="icon-btn"><i class="fas fa-users"></i></a>
            <a href="https://chat.whatsapp.com/C8BPddhMuTmE2Q0ZA8tIep" target="_blank" title="ро╡ро╛роЯрпНро╕рпНроЕрокрпН роХрпБро┤рпБ" class="icon-btn"><i class="fab fa-whatsapp-square"></i></a>
        </div>
    </footer>

</body>
              </html>
