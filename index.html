<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роиро╛ройрпН роХро╡ро┐родрпИ - Kavithai & Web3 Platform</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css"> 

    <script type="module" src="auth.js"></script> 
    <script type="module" src="script.js"></script> 
    <script type="module" src="search.js"></script> <script type="module">
        // Import necessary functions from Firebase SDKs
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // Import required search function from search.js
        import { executeSearchQuery } from "./search.js"; 

        const auth = getAuth(); 
        const provider = new GoogleAuthProvider();

        // 4. GOOGLE SIGN-IN FUNCTION 
        window.signInWithGoogle = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Google Sign-In Successful. User:", user);
                window.showToastNotification(`роЙро│рпНроирпБро┤рпИро╡рпБ ро╡рпЖро▒рпНро▒ро┐! Welcome ${user.displayName || 'роХро╡ро┐роЮро░рпЗ'}!`, 'success');
            } catch (error) {
                const errorCode = error.code;
                let errorMessage = "роЙро│рпНроирпБро┤рпИро╡ро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯродрпБ.";
                if (errorCode === 'auth/popup-closed-by-user') {
                    errorMessage = "роЙро│рпНроирпБро┤рпИро╡рпБ роЪро╛ро│ро░родрпНродрпИ роорпВроЯро┐ро╡ро┐роЯрпНроЯрпАро░рпНроХро│рпН.";
                } 
                console.error("Google Sign-In Error:", errorCode, error.message);
                window.showToastNotification(errorMessage, 'error');
            }
        };

        // 5. SIGN-OUT FUNCTION
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                window.showToastNotification("ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ ро╡рпЖро│ро┐ропрпЗро▒ро┐ройрпАро░рпНроХро│рпН.", 'info');
            } catch (error) {
                console.error("Sign Out Error:", error);
                window.showToastNotification("ро╡рпЖро│ро┐ропрпЗро▒рпБро╡родро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯродрпБ.", 'error');
            }
        };

        // 7. CORE FIX: Function to load the latest approved poems on the homepage
        async function loadHomepagePoems() {
            const listElement = document.getElementById('homepage-poem-list');
            if (!listElement) return;

            // Show loading state
            listElement.innerHTML = '<p style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> роХро╡ро┐родрпИроХро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ройрпНро▒рой...</p>';
            
            // Query Firestore for latest 10 approved poems (using search.js query logic)
            const latestPoems = await executeSearchQuery("", { sort: 'date-desc', theme: 'all', geo: 'global', token: 'none' });

            listElement.innerHTML = ''; // Clear loading state

            if (latestPoems.length === 0) {
                listElement.innerHTML = '<p style="text-align:center; color:#777;">роТрокрпНрокрпБродро▓рпН роЕро│ро┐роХрпНроХрокрпНрокроЯрпНроЯ роХро╡ро┐родрпИроХро│рпН роОродрпБро╡рпБроорпН роЗро▓рпНро▓рпИ. роиро┐ро░рпНро╡ро╛роХро┐ роТрокрпНрокрпБродро▓рпБроХрпНроХро╛роХроХрпН роХро╛родрпНродро┐ро░рпБроХрпНроХро╡рпБроорпН.</p>';
                return;
            }

             latestPoems.forEach(poem => {
                const card = document.createElement('div');
                card.className = 'poem-card'; 
                card.setAttribute('onclick', `window.location.href='poem_view?id=${poem.id}'`);

                const tags = poem.tags ? poem.tags.map(tag => `#${tag}`).join(' ') : '';
                
                card.innerHTML = `
                    <h3>${poem.title}</h3>
                    <p>${poem.content ? poem.content.substring(0, 100) : 'роЙро│рпНро│роЯроХрпНроХроорпН роЗро▓рпНро▓рпИ'}...</p>
                    <div class="card-footer" style="margin-top: 10px;">
                        <span class="likes" style="color:var(--primary-color);"><i class="fas fa-heart"></i> ${poem.likes || 0}</span>
                        <span class="rating" style="color:var(--warning-color); margin-left: 15px;"><i class="fas fa-star"></i> ${poem.averageRating ? poem.averageRating.toFixed(1) : 'N/A'}</span>
                    </div>
                `;
                listElement.appendChild(card);
            });
        }

        // 6. AUTH STATE LISTENER (Updates the UI based on login status)
        onAuthStateChanged(auth, (user) => {
            const loginSection = document.getElementById('login-section');
            const userProfileSection = document.getElementById('user-profile-section');
            const userNameDisplay = document.getElementById('user-name');
            const navCreatePoem = document.getElementById('nav-create-poem');
            const navAdmin = document.getElementById('nav-admin');
            
            if (user) {
                // Logged In State
                loginSection.style.display = 'none';
                userProfileSection.style.display = 'flex'; 
                userNameDisplay.textContent = user.displayName || user.email;
                navCreatePoem.style.display = 'block';

                // Admin check
                if (user.email === 'naankavithaiweb@gmail.com') { 
                    navAdmin.style.display = 'block';
                } else {
                    navAdmin.style.display = 'none';
                }
            } else {
                // Logged Out State
                loginSection.style.display = 'block';
                userProfileSection.style.display = 'none';
                navCreatePoem.style.display = 'none';
                navAdmin.style.display = 'none';
            }
            // Re-run loading logic on auth change if it affects personalization
            loadHomepagePoems();
        });
        
        // Call the function when the DOM is ready
        document.addEventListener('DOMContentLoaded', loadHomepagePoems);
    </script>
</head>
<body>

    <header>
        <div class="header-content">
            <h1>роиро╛ройрпН роХро╡ро┐родрпИ</h1>
            <p>родрооро┐ро┤ро┐ро▓рпН роХро╡ро┐родрпИроХро│рпН, Web3 & AI-ройрпН роЪроЩрпНроХроороорпН</p>
        </div>
        
        <nav>
            <a href="index.html">роорпБроХрокрпНрокрпБ (Feed)</a>
            <a id="nav-create-poem" href="create" style="display:none;"> 
                <i class="fas fa-feather-alt"></i> роХро╡ро┐родрпИ роЙро░рпБро╡ро╛роХрпНроХрпБ
            </a>
            <a href="forum">роЪроорпВроХроорпН (Forum)</a>
            <a href="monetization">роЪроирпНродро╛ (Premium)</a>
            <a id="nav-admin" href="admin" class="admin-link" style="display:none;">
                <i class="fas fa-cog"></i> роиро┐ро░рпНро╡ро╛роХроорпН
            </a>
            <a href="settings">роЕроорпИрокрпНрокрпБроХро│рпН</a>
        </nav>

        <div id="auth-container">
            <div id="login-section">
                <button onclick="signInWithGoogle()" class="google-sign-in-btn">
                    <i class="fab fa-google"></i> Google/Gmail роЙро│рпНроирпБро┤рпИро╡рпБ
                </button>
                <a href="web3" class="wallet-login-btn">
                    <i class="fas fa-wallet"></i> External Wallet Login (Web3)
                </a>
            </div>

            <div id="user-profile-section" style="display: none;">
                <span id="user-name-display">
                    <i class="fas fa-user-circle"></i> <span id="user-name"></span> роХрпНроХрпБ роиро▓рпНро╡ро░ро╡рпБ!
                </span>
                <a href="profile" class="profile-btn">роЪрпБропро╡ро┐ро╡ро░роорпН</a>
                <button onclick="signOutUser()" class="signout-btn">ро╡рпЖро│ро┐ропрпЗро▒рпБ</button>
                <i class="fas fa-bell notification-icon"></i> </div>
        </div>
        
    </header>

    <main>
        <h2>роЪроорпАрокродрпНродро┐роп роХро╡ро┐родрпИрокрпН рокродро┐ро╡рпБроХро│рпН</h2>
        <div id="homepage-poem-list">
            <p style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> роХро╡ро┐родрпИроХро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ройрпНро▒рой...</p>
        </div>
        
        <p style="text-align: center; margin-top: 30px;">
            <a href="search" class="approve-btn">ЁЯФО роЕройрпИродрпНродрпБроХрпН роХро╡ро┐родрпИроХро│рпИропрпБроорпН родрпЗроЯрпБ</a>
        </p>
    </main>

    <footer>
        <p class="copyright-text">&copy; 2024 роиро╛ройрпН роХро╡ро┐родрпИ. роЕройрпИродрпНродрпБ роЙро░ро┐роорпИроХро│рпБроорпН рокро╛родрпБроХро╛роХрпНроХрокрпНрокроЯрпНроЯро╡рпИ. | <a href="gdpr">GDPR/родро░ро╡рпБроХрпН роХрпЛро░ро┐роХрпНроХрпИ</a></p>
        
        <div class="contact-icons">
            <a href="mailto:naankavithaiweb@gmail.com" title="рооро┐ройрпНройроЮрпНроЪро▓рпН" class="icon-btn"><i class="fas fa-envelope"></i></a>
            <a href="https://wa.me/94752351754" target="_blank" title="ро╡ро╛роЯрпНро╕рпНроЕрокрпН (Mobile)" class="icon-btn"><i class="fab fa-whatsapp"></i></a>
            <a href="tel:+94752351754" title="роорпКрокрпИро▓рпН роЕро┤рпИрокрпНрокрпБ" class="icon-btn"><i class="fas fa-phone"></i></a>
            <a href="https://t.me/Mohammed_Sahan_1" target="_blank" title="роЯрпЖро▓ро┐роХро┐ро░ро╛роорпН ID" class="icon-btn"><i class="fab fa-telegram-plane"></i></a>
            <a href="https://t.me/Naan_kavithai" target="_blank" title="роЯрпЖро▓ро┐роХро┐ро░ро╛роорпН роЪрпЗройро▓рпН" class="icon-btn"><i class="fas fa-users"></i></a>
            <a href="https://chat.whatsapp.com/C8BPddhMuTmE2Q0ZA8tIep" target="_blank" title="ро╡ро╛роЯрпНро╕рпНроЕрокрпН роХрпБро┤рпБ" class="icon-btn"><i class="fab fa-whatsapp-square"></i></a>
        </div>
    </footer>

</body>
  </html>
